#!/bin/bash

dev () {
  tab gogo-dev $1
}

tab () {
  osascript 2>/dev/null <<EOF
    tell application "System Events"
      tell process "Terminal" to keystroke "t" using command down
    end
    tell application "Terminal"
      activate
      do script with command "cd \"$PWD\"; $*" in window 1
    end tell
EOF
}

# spin up ember server with live dev backend
live-dev () {
  # default to TYTHON Tunnel server - prob change this when I figure out what it is I do here
  server="0361"
  port="$2"

  # use first arg if given
  if [ ! -z "$1" ]
  then
    server="$1"

  # use env var if not empty
  elif [ ! -z $BP_HOSTNAME ]
  then
    server="$BP_HOSTNAME"
  fi

  # if we just passed a num assume normal test server format
  if [ ${#server} -le 4 ]
  then
    server="onxv$server.ott.ciena.com"
  fi

  # serve it up with live dev back end
  if [ -z $port ]
  then
    port="4300"
  fi

  ember s -e live-dev --proxy "https://$server" --secure-proxy=false --port=$port --live-reload-port="$port"1
}

# starts up watchman-processor, sets remote box working dir, and logs into screen session
gogo-dev () {
  cdir=$(pwd | sed s/^.*dev\\///)
  echo starting watchman-processor...
  echo see ~/.watchman-processor.config.js for details
  echo
  watchman-processor &>/dev/null &
  disown

  echo setting screen windows to match current working dir, running tests
  echo
  ssh dev -t "screen -x -p tests -X stuff 'source ~/.bash_profile && sleep 5 \r'"
  if [ -z "$1" ]
  then
    ssh dev -t "screen -x -p tests -X stuff '^C cd ~/dev/$cdir \r'"
  elif [ "$1" = "test" ]
  then
    ssh dev -t "screen -x -p tests -X stuff '^C cd ~/dev/$cdir && nombom && ember test \r'"
  else
    echo
    echo "option \"$1\" not recognized, please try again naked or with \"notest\""
    echo
    echo killing watchman-processor...
    sleep 5
    pgrep watchman-processor | xargs kill -9
    exit
  fi


  echo logging into screen session on dev box
  echo start session on target machine if this fails
  echo
  ssh dev -t "screen -x -p tests"

  echo killing watchman-processor...
  pgrep watchman-processor | xargs kill -9
  exit
}

nombom () {
  bower cache clean 
  rimraf node_modules bower_components dist tmp bower_components
  sleep 2
  npm install
  sleep 2
  bower install
}

alias fresh-dev-local='nombom && sleep 1 && ember serve'
alias fresh-dev-live='nombom && sleep 1 && ember live-dev'

join () {
  local IFS="$1"; shift; echo "$*";
}

work () {
  path="$HOME/dev"
  for i in $@
  do
    path="$path/$i"
  done

  cd $path
}

_work() 
{
  local cur prev opts
  COMPREPLY=()
  cur="${COMP_WORDS[COMP_CWORD]}"
  path="$HOME/dev/$(join / ${COMP_WORDS[@]:1:${#COMP_WORDS[@]}-2})/*/"
  opts="$(ls -d $path | sed -E 's/\/$//' | sed -E 's/^.*\///' | xargs echo)"

  COMPREPLY=($(compgen -W "${opts}" ${cur}))
  return 0
}

complete -F _work work
